<%- include('../parsials/header.ejs') %>
<link rel="stylesheet" href="<%= process.env.CDN %>assets2/css/vendor.min.css">
<style type="text/css">
.errorFild{
  border-color: #ed4c78;
}
</style>
 <%- include('../parsials/nav.ejs')%>
<body class="sticky-navigation shadow-layout light-header">
  <dev id="main"> <%- include('../parsials/navBar.ejs')%>

   <main id="content" role="main" class="main">
      <!-- Content -->
      <div class="content container-fluid">
        <!-- Stats -->
        <div class="row gx-2 gx-lg-3">
          <div class="col-sm-6 col-lg-3 mb-3 mb-lg-5">
            <!-- Card -->
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-2">Total users</h6>

                <div class="row align-items-center gx-2">
                  <div class="col">
                    <span class="js-counter display-4 text-dark"><%= user.length %></span>
                  </div>

                  <div class="col-auto">
                    <span class="badge badge-soft-success p-1">
                      <i class="tio-trending-up"></i> 5.0%
                    </span>
                  </div>
                </div>
                <!-- End Row -->
              </div>
            </div>
            <!-- End Card -->
          </div>

          <div class="col-sm-6 col-lg-3 mb-3 mb-lg-5">
            <!-- Card -->
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-2">Active members</h6>

                <div class="row align-items-center gx-2">
                  <div class="col">
                    <span class="js-counter display-4 text-dark">12</span>
                  </div>

                  <div class="col-auto">
                    <span class="badge badge-soft-success p-1">
                      <i class="tio-trending-up"></i> 1.2%
                    </span>
                  </div>
                </div>
                <!-- End Row -->
              </div>
            </div>
            <!-- End Card -->
          </div>

          <div class="col-sm-6 col-lg-3 mb-3 mb-lg-5">
            <!-- Card -->
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-2">New/returning</h6>

                <div class="row align-items-center gx-2">
                  <div class="col">
                    <span class="js-counter display-4 text-dark">56</span>
                    <span class="display-4 text-dark">%</span>
                  </div>

                  <div class="col-auto">
                    <span class="badge badge-soft-danger p-1">
                      <i class="tio-trending-down"></i> 2.8%
                    </span>
                  </div>
                </div>
                <!-- End Row -->
              </div>
            </div>
            <!-- End Card -->
          </div>

          <div class="col-sm-6 col-lg-3 mb-3 mb-lg-5">
            <!-- Card -->
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-2">Active members</h6>

                <div class="row align-items-center gx-2">
                  <div class="col">
                    <span class="js-counter display-4 text-dark">28.6</span>
                    <span class="display-4 text-dark">%</span>
                    <span class="text-body font-size-sm ml-1">from 28.6%</span>
                  </div>

                  <div class="col-auto">
                    <span class="badge badge-soft-secondary p-1">0.0%</span>
                  </div>
                </div>
                <!-- End Row -->
              </div>
            </div>
            <!-- End Card -->
          </div>
        </div>
        <!-- End Stats -->

        <!-- Card -->
        <div class="card">
          <!-- Header -->
          <div class="card-header">
            <div class="row justify-content-between align-items-center flex-grow-1">
              <div class="col-sm-6 col-md-4 mb-3 mb-sm-0">
                <form>
                  <!-- Search -->
                  <div class="input-group input-group-merge input-group-flush">
                    <div class="input-group-prepend">
                      <div class="input-group-text">
                        <i class="tio-search"></i>
                      </div>
                    </div>
                    <input id="datatableSearch" type="search" class="form-control" placeholder="Search users" aria-label="Search users">
                  </div>
                  <!-- End Search -->
                </form>
              </div>

              <div class="col-sm-6">
                <div class="d-sm-flex justify-content-sm-end align-items-sm-center">
                  
                  <!-- <div id="datatableCounterInfo" class="mr-2 mb-2 mb-sm-0" style="display: none;">
                    <div class="d-flex align-items-center">
                      <span class="font-size-sm mr-3">
                        <span id="datatableCounter">0</span>
                        Selected
                      </span>
                      <a class="btn btn-sm btn-outline-danger" href="javascript:;">
                        <i class="tio-delete-outlined"></i> Delete
                      </a>
                    </div>
                  </div> -->
                  <div class="row align-items-end">
            <div class="col-sm-auto">
              <button
              class="btn btn-primary btn-block mr-3"
              data-toggle="modal"
              data-target="#addUserModal"
            >
              <i data-feather="plus" class="mr-2"></i>
              Add employee
            </button>
            </div>
          </div>

                 
                </div>
              </div>
            </div>
            <!-- End Row -->
          </div>
          <!-- End Header -->

          <!-- Table -->
          <div class="table-responsive datatable-custom">
            <table id="datatable" class="table table-lg table-borderless table-thead-bordered table-nowrap table-align-middle card-table"
                   data-hs-datatables-options='{
                     "columnDefs": [{
                        "targets": [0, 7],
                        "orderable": false
                      }],
                     "order": [],
                     "info": {
                       "totalQty": "#datatableWithPaginationInfoTotalQty"
                     },
                     "search": "#datatableSearch",
                     "entries": "#datatableEntries",
                     "pageLength": 15,
                     "isResponsive": true,
                     "isShowPaging": false
                   }'>
              <thead class="thead-light">
                <tr>
                  <th class="table-column-pr-0">
                    <div class="custom-control custom-checkbox">
                      <input id="datatableCheckAll" type="hidden" class="custom-control-input">
                    </div>
                  </th>
                  <th class="table-column-pl-0">Name</th>
                  <!-- <th>Position</th> -->
                  <th class="table-column-pl-0">Status</th>
                  <th class="table-column-pl-0">Role</th>
                  <th class="table-column-pl-0"></th>
                  <th class="table-column-pl-0"></th>
                </tr>
              </thead>

              <tbody>
              <% for( let info of user ) { %> 
                <tr>
                  <td class="table-column-pr-0">
                  </td>
                  <td class="table-column-pl-0">
                    <a class="d-flex align-items-center" href="/tadmin/profile/<%= info._id %>">
                      <div class="avatar avatar-circle">
                        <img class="avatar-img" src='<%= info.avatar ? `${process.env.CDN}/uploads/avatars/${info.avatar}` : `${process.env.CDN}/assets2/img/160x160/img1.jpg` %>' alt="avatar">
                      </div>
                      <div class="ml-3">
                        <span class="d-block h5 text-hover-primary mb-0"><%= `${info.name.firstname} ${info.name.lastname}` %></span>
                        <span class="d-block font-size-sm text-body"><%= info.email %></span>
                      </div>
                    </a>
                  </td>
                  <!-- <td>
                    <span class="d-block h5 mb-0">Director</span>
                    <span class="d-block font-size-sm">Human resources</span>
                  </td> -->
                  <!-- <td> <span class="text-hide">Code: GB</span></td> -->
                  <td class="table-column-pl-0">
                    <span class="legend-indicator <%= info.status == 'active' ? 'bg-success' : 'bg-danger'%>"></span><%= info.status %>
                  </td>
                  <td class="table-column-pl-0"><%= info.roule %></td>
                  <td class="table-column-pl-0">
                      <a class="btn btn-sm btn-danger deleteUser" href="/tadmin/employees/delete/<%= info._id %> " style="color: #fff">
                        <i class="mr-1"data-feather="trash"></i>Remove
                      </a>
                  </td>
                  <td class="table-column-pl-0">
                      <button class="btn btn-sm btn-warning editBtnUsers" data-toggle="modal" data-target="#editUserModal" data-roule='<%= info.roule %>' data-status='<%= info.status %>' data-id='<%= info._id %>'>
                        <i class="tio-edit pr-1"></i> Edit
                      </button>
                  </td>
                </tr>
              <% } %> 
              </tbody>
            </table>
          </div>
          <!-- End Table -->
        </div>
        <!-- End Card -->
      </div>
      <!-- End Content -->

    </main>

<!-- Add user Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <!-- Header -->
          <div class="modal-header">
            <h4 id="editUserModalTitle" class="modal-title">Add Employee</h4>

            <button type="button" class="btn btn-icon btn-sm btn-ghost-secondary" data-dismiss="modal" aria-label="Close">
              <i class="tio-clear tio-lg"></i>
            </button>
          </div>
          <!-- End Header -->

          <!-- Body -->
          <div class="modal-body">
        
            <!-- Tab Content -->
            <div class="tab-content" id="editUserModalTabContent">
              <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <form autocomplete="off" id="addUserForm" action="/tadmin/employees/" method="post">
                  <!-- Form Group -->
                  <div class="row form-group">
                    <label for="editFirstNameModalLabel" class="col-sm-3 col-form-label input-label">Full name</label>

                    <div class="col-sm-9">
                      <div class="js-form-message input-group input-group-sm-down-break">
                         <div id='firstname-error' class="invalid-feedback d-block"></div>
                        <input type="text" class="form-control" name="firstname" id="editFirstNameModalLabel" placeholder="first name" >
                        
                         <div id='lastname-error' class="invalid-feedback d-block"></div>
                        <input type="text" class="form-control" name="lastname" id="editLastNameModalLabel" placeholder="last name" >
                      </div>
                    </div>
                  </div>
                  <!-- End Form Group -->

                  <!-- Form Group -->
                  <div class="row form-group">
                    <label for="editEmailModalLabel" class="col-sm-3 col-form-label input-label">Email</label>

                    <div class="col-sm-9">
                      <div class="js-form-message">
                         <div id='email-error' class="invalid-feedback d-block"></div>
                        <input type="email" class="form-control" name="email" id="editEmailModalLabel" placeholder="Email" >
                      </div>
                    </div>
                  </div>
                  <!-- End Form Group -->

                  <!-- Form Group -->
                  <div class="row form-group">
                    <label for="editEmailModalLabel" class="col-sm-3 col-form-label input-label">Username</label>

                    <div class="col-sm-9">
                      <div class="js-form-message">
                        <div id='username-error' class="invalid-feedback d-block"></div>
                        <input type="text" class="form-control" name="username" id="editEmailModalLabel" placeholder="username" >
                      </div>
                    </div>
                  </div>
                  <!-- End Form Group -->

                  <!-- Form Group -->
                  <div class="row form-group">
                    <label for="editOrganizationModalLabel" class="col-sm-3 col-form-label input-label">Roule</label>

                    <div class="col-sm-9">
                      <div class="js-form-message">
                        <!-- Select2 -->
                        <div id='roule-error' class="invalid-feedback d-block"></div>
                        <select class="js-select2-custom custom-select" size="1"
                                data-hs-select2-options='{
                                "minimumResultsForSearch": "Infinity",
                                "placeholder": "Select roule"
                                }'
                                name="roule">
                            <option value="empty">set roule</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="srDev">Senior Developer</option>
                            <option value="jrDev">Junior Developer</option>
                            <option value="designer">Designer</option>
                            
                        </select>
                        <!-- End Select2 -->
                      </div>
                    </div>

                  </div>
                  <!-- End Form Group -->
                  <input type="hidden" class="form-control" value="active" name="status">
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-white mr-2" data-dismiss="modal" aria-label="Close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
            <!-- End Tab Content -->
          </div>
          <!-- End Body -->
        </div>
      </div>
    </div>

<!-- Edit user Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <!-- Header -->
          <div class="modal-header">
            <h4 id="editUserModalTitle" class="modal-title">Edit Employee</h4>

            <button type="button" class="btn btn-icon btn-sm btn-ghost-secondary" data-dismiss="modal" aria-label="Close">
              <i class="tio-clear tio-lg"></i>
            </button>
          </div>
          <!-- End Header -->

          <!-- Body -->
          <div class="modal-body">
        
            <!-- Tab Content -->
            <div class="tab-content" id="editUserModalTabContent">
              <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <form id='editUserForm' action="/tadmin/employees/" method="POST">
                  <!-- Form Group -->
                  <input type="hidden" class="form-control" value='' name="userId">
                  

                  <!-- Form Group -->
                  <div class="row form-group">
                    <label for="editOrganizationModalLabel" class="col-sm-3 col-form-label input-label">Roule</label>

                    <div class="col-sm-9">
                      <div class="js-form-message">
                        <!-- Select2 -->
                        <select class="js-select2-custom custom-select" size="1"
                                data-hs-select2-options='{
                                "minimumResultsForSearch": "Infinity",
                                "placeholder": "Select roule"
                                }'
                                name="rouleEdit"
                                value=''>
                            
                            <option value="empty">set roule</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="srDev">Senior Developer</option>
                            <option value="jrDev">Junior Developer</option>
                            <option value="design">Designer</option>
                            
                        </select>
                        <!-- End Select2 -->
                      </div>
                    </div>

                  </div>
                  <!-- End Form Group -->

                  <!-- Form Group -->
                  <div class="row form-group">
                    <label class="col-sm-3 col-form-label input-label">Account status</label>

                    <div class="col-sm-9">
                      <div class="js-form-message">
                        <!-- Select2 -->
                        <select class="js-select2-custom custom-select" size="1"
                                data-hs-select2-options='{
                                "minimumResultsForSearch": "Infinity",
                                "placeholder": "status"
                                }'
                                name="statusEdit"
                                value=''>
                            <option value="empty">set status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                        </select>
                        <!-- End Select2 -->
                      </div>
                      </div>
                    </div>
                  </div>
                  <!-- End Form Group -->
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-white mr-2" data-dismiss="modal" aria-label="Close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
            <!-- End Tab Content -->
          </div>
          <!-- End Body -->
        </div>
</div>
    <!-- End user Modal -->
</dev>


    <!-- JS Implementing Plugins -->
    <script src="<%= process.env.CDN %>assets2/js/vendor.min.js"></script>
    
    

    <!-- JS Front -->
    <script src="<%= process.env.CDN %>assets2/js/theme.min.js"></script>
    <!-- JS Plugins Init. -->
    <script>


        let addForm = document.querySelector('#addUserForm')
        
        addForm.onsubmit = async (event) => {
          // disbale reload on form submit
          try {
            event.preventDefault();

          // remove error message
          const errfields = document.querySelectorAll("div.invalid-feedback");
          for (let i = 0; i < errfields.length; i++) {
            errfields[i].innerHTML = ''
          }
          // remove error field color
          const inputErrors = document.querySelectorAll(".errorFild");
          if (inputErrors.length > 0) {
            for (let j = 0; j < inputErrors.length; j++) {
              inputErrors[j].classList.remove("errorFild");
            }
          }
          // form data
          let formData = new URLSearchParams(new FormData(addForm));
          // send data to server
          let response = await fetch('/tadmin/employees', {
            method: 'POST',
            body: formData,
          });
          // response from serevr
          let result = await response.json();
          // if server send error
          console.log(response);
          console.log(result.error);
          console.log(result);
          if(result.error){
            // get keys from error object 
            Object.keys(result.error).forEach(fieldName => {
              // class for make red input field on error
              addForm[fieldName].classList.add('errorFild'); 

              // getting error message field for show message
              const errfields = document.querySelector(`#${fieldName}-error`);
              console.log(errfields);
              errfields.innerHTML = result.error[fieldName].msg
            }) 
          } else {

            // reload after 1s
            setTimeout(() => {
              location.reload();
            }, 1000);
          }
          } catch (error) {
            console.log(error);
          }
        }
        

      $(document).on('ready', function () {

        // User edit 
        
        
        
        // INITIALIZATION OF FORM SEARCH
        // =======================================================
        $('.js-form-search').each(function () {
          new HSFormSearch($(this)).init()
        });


        
        // INITIALIZATION OF SELECT2
        // =======================================================
        $('.js-select2-custom').each(function () {
          var select2 = $.HSCore.components.HSSelect2.init($(this));
        });

        
        // INITIALIZATION OF COUNTERS
        // =======================================================
        $('.js-counter').each(function() {
          var counter = new HSCounter($(this)).init();
        });

      });
    </script>
     <%- include('../parsials/footer.ejs') %>

</body>
</html>